# ESP32 LVGL 天气时钟 (LVGL Weather Station)

基于 ESP-IDF 框架和 LVGL 图形库实现的一款拥有精美深色现代界面的 ESP32-S3 天气和时钟设备。

## 🎯 核心功能

- **时钟与日期显示**：SNTP NTP 实时网络时间同步，自动校准，并展示当前星期与日期。
- **天气聚合展示**：定时抓取和风天气 (QWeather API)，显示气温、体感温度、风速、湿度以及天气描述。
- **动态字库支持**：采用 LVGL 8.3 并配置了自定义的**中文字体**（LXGW WenKai Lite 霞鹜文楷 16px和36px），带有多层级页面平滑切换。
- **HTTP/GZIP 解析优化**：内置对压缩格式（GZIP）JSON 报文的 miniz 流式解压支持，减少网络带宽消耗，大幅节省 ESP32 的内存占用。
- **时间同步与 HTTPS**：解决了系统在 SNTP 授时未成功前，发送 HTTPS 导致 TLS/SSL 服务器证书验证报错（时间锚定到 1970 年）的问题。
- **AP + Web 配网**：纯按键驱动。第一次开机或按下 BOOT 键 5 秒即可开启热点并进入配置网页，用户可接入后可视化配置网络密码和天气请求参数（如城市代码）。
- **状态恢复与 NVS 保存**：配置项一次写入后续自动连接。长按 BOOT 键 8 秒可将设备恢复至出厂状态。

---

## 🛠️ 硬件需求

- **主控芯片**: ESP32-S3
- **屏幕**: 1.15 英寸 / 1.14 英寸 SPI ST7789 TFT LCD，分辨率 135x240。
- **按键**: 利用主板自带的 BOOT 按键 (GPIO 0)。
- **存储要求**: 启用 2MB/4MB 或以上 Flash (预设 partitions 已配置 factory 2MB + NVS 空间)。

### 引脚接线参考 (可于 `app_hal.c` 中修改)
| 信号 | ESP32-S3 引脚 |
|----|----|
| SPI MOSI | 35 |
| SPI SCLK | 36 |
| LCD CS | 7 |
| LCD DC | 39 |
| LCD RST | 40 |
| LCD 背光 (LEDC) | 45 |
| 屏幕使能/电源 | 21 |
| BOOT 配置键 | 0 |

---

## 🚀 编译与运行说明

### 1. 安装 ESP-IDF 开发环境
如果您还未配置过 ESP-IDF，请前往 [Espressif 官方指南环境搭建网页](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/get-started/index.html) 下载并安装最新的 工具链（推荐 v5.x 版本）。

在您的终端或 WSL 环境中载入 IDF 变量（请根据您的根目录调整路径）：
```bash
. $IDF_PATH/export.sh
```

### 2. 设置和风天气 API Key
在开始编译前，必须配置真实的天气请求密钥，否则天气部分数据无法更新。
1. 前往 **[和风天气控制台](https://console.qweather.com/)** 注册开发者账号。
2. 申请并建立一个免费订阅的 API Key。
3. 打开工程中的源码文件 `main/app_weather.c`，找到如下代码行并替换其中引用的字符串：
```c
// 替换这里:
#define WEATHER_API_KEY "您的_API_KEY_粘贴在这里"
```

### 3. 配置、编译与烧录

1. **设置目标芯片** (默认为 ESP32-S3)
   ```bash
   idf.py set-target esp32s3
   ```

2. **编译固件**
   执行构建指令，等待组件自动拉取（LVGL、esp_lcd 等）：
   ```bash
   idf.py build
   ```

3. **烧录与监听终端**
   将板子接上 USB 到电脑，配置好通过串口或者 JTAG 的映射后执行（假设 Linux / WSL 下常见口径为 `/dev/ttyACM0`）：
   ```bash
   idf.py -p /dev/ttyACM0 flash monitor
   ```
   > 提示：按 `Ctrl + ]` 可退出 Monitor 控制台程序。

---

## 🌐 首次使用及配网说明

烧写完毕后开机会在屏幕上显示待配网提示。
若因超时未进入或之后需要**重设 WiFi**:
1. 观察设备启动或正常运行过程中，**按住 BOOT 键并保持 5 秒钟**后松开。
2. 此时屏幕将切换至配网提示符页面，且 ESP32-S3 发出一个名为 `ESP32_Weather` 的无密码 WiFi 热点。
3. 使用手机或电脑连接上热点 `ESP32_Weather`。
4. 打开浏览器，输入网址 `http://192.168.4.1`。
5. 在页面中填入您家中的 **WiFi 名称**、**密码**、城市名称对应的（**拼音/LocationID**，例如北京为 101010100 ）以及显示单位并保存。
6. 设备收到配置后将重启重新连接网络。只要有外网，时间与天气就会自动同步并展示！

### 🗑 恢复出厂设置
如果遇到难以挽回的网络故障，**长按 BOOT 键超过 8 秒**，设备将触发格式化清空所有的缓存及用户配置，随后直接硬重启回退为初始状态。

---

## 💡 二次开发与个性化提示

本项目采用了高度解耦结构设计。如有自定义需求，可直接介入如下子模块：
* `app_hal.c` 更改屏幕通信总线、背光亮度或长短按键分配时间；
* `app_ui.c` 开发自定义绚丽的 LVGL 页面动画效果，或者调整字体大小和布局位置；
* `app_weather.c` 添加未来逐小时预热或者空气质量模块（解压后使用 cJSON 解析即可）；
* `app_time.c` 修改 SNTP 授时服务器或支持多时区显示。

**开源协议**: MIT License
